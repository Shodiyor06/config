{% extends 'base.html' %}
{% load static %}

{% block title %}Kirish - O'quv Markazi{% endblock %}

{% block content %}
<section class="auth-section">
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <i class="fas fa-graduation-cap auth-icon"></i>
                <h2>Xush Kelibsiz</h2>
                <p>Platformaga kirish uchun ma'lumotlaringizni kiriting</p>
            </div>

            <form id="loginForm" class="auth-form">
                <div class="form-group">
                    <label for="phone">
                        <i class="fas fa-phone"></i>
                        Telefon raqam
                    </label>
                    <input
                        type="tel"
                        id="phone"
                        placeholder="90 123 45 67"
                        required
                        class="form-input"
                    >
                </div>

                <div class="form-group">
                    <label for="password">
                        <i class="fas fa-lock"></i>
                        Parol
                    </label>
                    <div class="password-input">
                        <input
                            type="password"
                            id="password"
                            placeholder="Parol"
                            required
                            class="form-input"
                        >
                        <button type="button" class="password-toggle" onclick="togglePassword()">
                            <i class="fas fa-eye" id="toggleIcon"></i>
                        </button>
                    </div>
                </div>

                <div class="alert alert-error" id="errorMessage" style="display:none;">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="errorText"></span>
                </div>

                <button type="submit" class="btn btn-primary btn-block btn-lg" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Kirish
                </button>
            </form>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
function togglePassword() {
    const input = document.getElementById('password');
    const icon = document.getElementById('toggleIcon');
    input.type = input.type === 'password' ? 'text' : 'password';
    icon.classList.toggle('fa-eye');
    icon.classList.toggle('fa-eye-slash');
}

document.getElementById('loginForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    let phoneRaw = document.getElementById('phone').value.replace(/\D/g, '');
    const password = document.getElementById('password').value.trim();
    const errorBox = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    const btn = document.getElementById('loginBtn');

    if (!phoneRaw || !password) {
        errorText.textContent = 'Barcha maydonlarni toâ€˜ldiring';
        errorBox.style.display = 'flex';
        return;
    }

    // ðŸ”¥ HAR DOIM 998 BILAN YUBORAMIZ
    if (!phoneRaw.startsWith('998')) {
        phoneRaw = '998' + phoneRaw;
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kuting...';

    try {
        const res = await fetch('/api/auth/login/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({
                phone: phoneRaw,
                password: password
            })
        });

        const data = await res.json();

        if (!res.ok) {
    throw new Error(data.detail || 'Login yoki parol notoâ€˜gâ€˜ri');
}

    errorBox.style.display = 'none';
    
    // ROLE BOâ€˜YICHA REDIRECT
    if (data.role === 'TEACHER') {
        window.location.href = '/teacher/';
    } else if (data.role === 'STUDENT') {
        window.location.href = '/student/';
    } else {
        // fallback
        window.location.href = '/profile/';
    }


    } catch (err) {
        errorText.textContent = err.message;
        errorBox.style.display = 'flex';
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Kirish';
    }
});

// ðŸ”§ INPUT â€” 9 TA RAQAM (998 SIZ)
document.getElementById('phone').addEventListener('input', function () {
    this.value = this.value.replace(/\D/g, '').slice(0, 9);
});
</script>
{% endblock %}
